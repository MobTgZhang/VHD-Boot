# Fedora Kloop
This tutorial is applicable to any Linux operating system based on Fedora Linux,I'm using [fedora 32](https://getfedora.org/) system for example.
## 1.Create a fixed size VHD virtual hard disk
First of all,create a fixed-size VHD file using virtualbox,and install fedora linux system in the file.
## 2. Install some of useful tools
At first,we should install `kpartx,util-linux,dm-setup,lvm2`.In the terminal of the virtualbox running system,we type the following command:
```bash
sudo yum install kpartx util-linux device-mapper lvm2
```
or use `dnf` command to installl the software.
## 3. Compile and install ntfs-3g
Download `ntfs-3g_ntfsprogs-2017.3.23-fixed` from the project,we compile and install it manually. After unziping to your `home` directory,open a terminal and go to the directory , execute the following commands in turn:
```bash
./configure
make
sudo make install
```
**Note:**You need to install `gcc,g++ build-essential make` and other software in advance:
```bash
sudo yum install gcc,g++ build-essential make
```
This step is mainly intended to resolve the "Buffer I/O error" during shutdown process on systemd Linux. Refered to the following website:[RootStorageDaemons](http://www.freedesktop.org/wiki/Software/systemd/RootStorageDaemons/) and [InitrdInterface](http://www.freedesktop.org/wiki/Software/systemd/InitrdInterface/).
## 4.Modify the file
Here we modify two files.The configuration of the file is that `/lib/dracut/dracut.conf.d/01-dist.conf`.Backup the file and edit it:
```bash
sudo cp /lib/dracut/dracut.conf.d/01-dist.conf /lib/dracut/dracut.conf.d/01-dist.conf-backup
``` 
We can file the line where the string `install_optional_items+` in it,add ` blkid losetup  kpartx partx mount.fuse mount.ntfs-3g ntfs-3g shutdown  lvm  vgchange  vgmknodes  vgscan  dmsetup dmeventd` in the line,and fianlly modify it as follows:
```bash
install_optional_items+=" vi /etc/virc ps grep cat rm blkid losetup  kpartx partx mount.fuse mount.ntfs-3g ntfs-3g shutdown lvm  vgchange  vgmknodes  vgscan  dmsetup dmeventd  "
```
Comment out `hostonly` to make that line become as follows:
```bash
# hostonly=yes
```
Save it and exit.
And anther configuration file is that `/etc/dracut.conf`.In general, all kernels generated by `dracut` uses the configuration files in directory `/etc/dracut.conf.d/` and  `/etc/dracut.conf`. We can modify the `/etc/dracut.conf` directly , modify some of files in `/etc/dracut.conf.d/` or create a configuration file in `/etc/dracut.conf.d/` to change the environment and compile the kernel.Here we choose the file `/etc/dracut.conf`.
Backup and edit the file:
```bash
sudo cp /etc/dracut.conf /etc/dracut.conf-backup
sudo nano /etc/dracut.conf
```
Find the line `# additional kernel modules to the default`,and then modify it as follows:
```bash
# additional kernel modules to the default
add_drivers+="fuse dm-mod "
```
Save it and exit.
## 5.Genrate the kernel 
Download the `10-vhdmount-kloop.sh`, here we download the file in the `home` directory,and then open a terminal and using the following command to generate the kernel:
```bash
sudo dracut -i ~/10-vhdmount-kloop.sh /lib/dracut/hooks/pre-mount/10-vhdmount.sh  ~/dracut-fedora-kloop
```
The `dracut-fedora-kloop` file which is the kernel file to boot the VHD file generated in the `home` directory.Next,you should put the `dracut-fedora-kloop` file , the same version of `vmlinuz` file (which is located in directory `/boot/vmlinux-XXXXXXXXXXXXXX`) and the VHD file  outside in a same directory.
## 6.Boot settings
Here we suppose that the three files are:`fedora32.vhd,initramfs-5.6.6-300.fc32.x86_64.img,vmlinuz-5.6.6-300.fc32.x86_64`.Except that,we don't use LVM, and the root partition is on the first partition in the VHD file.So we set the parameter `kroot=/dev/mapper/loop0p1`

The boot menu as follows:
for GRUB4DOS:
```bash
title  Fedora 32 VHD
find --set-root --ignore-floppies --ignore-cd /fedora/fedora32.vhd
uuid ()
kernel   /fedora/vmlinuz-5.6.6-300.fc32.x86_64  root=UUID=%?% kloop=/fedora/fedora32.vhd kroot=/dev/mapper/loop0p3 
initrd   /fedora/initramfs-5.6.6-300.fc32.x86_64.img
```
for grub2:
```bash
menuentry ' Fedora 32 VHD'  --class fedora  {
	insmod gzio
	insmod part_msdos
	insmod part_gpt
	insmod ext2
	insmod ntfs
	insmod probe
	insmod search
    set vhdfile="/fedora/fedora32.vhd"
	search --no-floppy -f --set=aabbcc   $vhdfile
	set root=${aabbcc}
	probe -u --set=ddeeff ${aabbcc}
	linux	  /fedora/vmlinuz-5.6.6-300.fc32.x86_64  root=UUID=${ddeeff} kloop=$vhdfile kroot=/dev/mapper/loop0p1  
	initrd	  /fedora/initramfs-5.6.6-300.fc32.x86_64.img 
}
```
If you install Fedora with a fixed-size VHD and LVM is used on VHD,you can use the following menu to boot:
```bash
menuentry " Fedora 32 LVM VHD" --class  fedora {
        insmod gzio
        insmod part_msdos
        insmod part_gpt
        insmod ext2
        insmod ntfs
        insmod probe
        set root=(hd0,1)
        set vhdfile="/fedora/fedora32.vhd"
        search --no-floppy -f --set=aabbcc  $vhdfile
        set root=${aabbcc}
        probe -u --set=ddeeff ${aabbcc}
        linux   /fedora/vmlinuz-5.6.6-300.fc32.x86_64 root=UUID=${ddeeff} kloop=$vhdfile kroot=/dev/mapper/fedora-root klvm=fedora
        initrd  /fedora/initramfs-5.6.6-300.fc32.x86_64.img
}
```
**Note 1.** To simplify the kernel files, we can apply the following command to install only the necessary kernel files:
```bash
sudo dracut  -i ~/mydracut/10-vhdmount-kloop.sh /lib/dracut/hooks/pre-mount/10-vhdmount-kloop.sh  --no-hostonly  --install " vi /etc/virc ps grep cat rm blkid losetup  kpartx partx mount.fuse mount.ntfs-3g ntfs-3g shutdown lvm  vgchange  vgmknodes  vgscan  dmsetup dmeventd  "   --add-drivers  "fuse dm-mod "  -o " plymouth btrfs crypt  cifs fcoe fcoe-uefi iscsi nfs nbd"   ~/dracut-fedora-kloop
```
**Note 2.** To look inside the kernel file for directories and parameters,use the following command:
```bash
lsinitrd dracut-fedora | less
```
**Note 3.** If you have a LINUX system installed using a fixed-size VHD, use the same version of the kernel module directory on the LINUX system as the `initrd. Img-xxxxxx-generic` that you made to boot VHD.For example, `/lib/modules/5.3.0-3-generic` copy to the `/lib/modules/` directory in the VHD system with permissions set to 755.You can use this Linux kernel to boot into the VHD system,otherwise it can't boot correctly or missing some of modules. It booted successfully on `Fedora Mageia OpensUse ArchLinux` and many other systems.
